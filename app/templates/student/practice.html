{% extends "base/base.html" %}

{% block title %}Practicar - MathMentor IA{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4"><i class="bi bi-pencil-square"></i> Área de Práctica</h2>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="exercise-container" id="exercise-area">
            <div id="no-exercise" class="text-center py-5">
                <i class="bi bi-lightbulb" style="font-size: 4rem; color: #ffc107;"></i>
                <h4 class="mt-3">¿Listo para practicar?</h4>
                <p class="text-muted">Genera un ejercicio para comenzar</p>

                <div class="mt-4">
                    <label class="form-label">Dificultad:</label>
                    <select class="form-select w-50 mx-auto" id="difficulty-select">
                        <option value="easy">Primeros pasos</option>
                        <option value="medium" selected>Consolidación</option>
                        <option value="hard">Preparación para exámen</option>
                    </select>
                </div>

                <button class="btn btn-primary btn-lg mt-4" id="generate-btn">
                    <i class="bi bi-stars"></i> Generar Ejercicio
                </button>
            </div>

            <div id="exercise-display" class="d-none">
                <div class="alert alert-info">
                    <strong>Tema:</strong> <span id="exercise-topic"></span>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-question-circle"></i> Ejercicio</h5>
                    </div>
                    <div class="card-body">
                        <div id="exercise-content" class="fs-5 markdown-content"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="student-answer" class="form-label"><strong>Tu Respuesta:</strong></label>
                    <textarea class="form-control" id="student-answer" rows="3" placeholder="Escribe tu respuesta aquí..."></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label"><strong>Procedimientos/Técnicas Utilizadas:</strong></label>
                    <div class="card">
                        <div class="card-body" id="procedures-list">
                            <p class="text-muted">Selecciona todos los procedimientos, técnicas o propiedades que utilizaste para resolver este ejercicio.</p>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-success btn-lg" id="submit-btn">
                        <i class="bi bi-check-circle"></i> Enviar Respuesta
                    </button>
                    <button class="btn btn-warning" id="hint-btn">
                        <i class="bi bi-lightbulb"></i> <span id="hint-btn-text">Comprar Pista 1 (5 puntos)</span>
                    </button>
                </div>

                <div id="hint-display" class="alert alert-warning mt-3 d-none">
                    <h6><i class="bi bi-lightbulb-fill"></i> <span id="hint-title">Pista:</span></h6>
                    <div id="hint-content"></div>
                </div>
            </div>

            <div id="feedback-display" class="d-none mt-4">
                <!-- Feedback will be inserted here -->
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Topic Summaries Card -->
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-book"></i> Resúmenes de Temas</h5>
            </div>
            <div class="card-body">
                <p class="small text-muted">Compra resúmenes para estudiar antes de practicar</p>
                {% if topics %}
                <div class="list-group list-group-flush">
                    {% for topic in topics %}
                    <div class="list-group-item p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="small">{{ topic.topic_name }}</span>
                            {% if topic.id in purchased_topic_ids %}
                            <button class="btn btn-sm btn-info buy-summary-btn" data-topic-id="{{ topic.id }}" data-topic-name="{{ topic.topic_name }}">
                                <i class="bi bi-check-circle"></i> Ver (GRATIS)
                            </button>
                            {% else %}
                            <button class="btn btn-sm btn-success buy-summary-btn" data-topic-id="{{ topic.id }}" data-topic-name="{{ topic.topic_name }}">
                                <i class="bi bi-cart-plus"></i> 15pts
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted small">No tienes temas asignados. Contacta con tu profesor.</p>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-trophy"></i> Tu Progreso</h5>
            </div>
            <div class="card-body text-center">
                <div class="score-badge bg-primary text-white mb-3">
                    <span id="points-display">{{ stats.available_points if stats else 0 }}</span>
                </div>
                <p><strong>Puntos Disponibles</strong></p>

                <hr>

                <div class="streak-indicator mb-2">
                    <i class="bi bi-fire"></i> Racha: <span id="streak-display">{{ stats.current_streak if stats else 0 }}</span>
                </div>

                <p class="text-muted small mt-3">
                    <strong>Precisión:</strong> {{ stats.accuracy_rate if stats else 0 }}%<br>
                    <strong>Ejercicios:</strong> {{ stats.total_exercises if stats else 0 }}
                </p>
            </div>
        </div>

        <!-- Scientific Calculator Button -->
        <div class="card mt-3">
            <div class="card-body text-center">
                <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#calculatorModal">
                    <i class="bi bi-calculator"></i> Calculadora Científica
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Summary Modal -->
<div class="modal fade" id="summaryModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <div>
                    <h5 class="modal-title mb-1"><i class="bi bi-book-fill"></i> Resumen: <span id="summary-topic-name"></span></h5>
                    <p class="mb-0 small"><i class="bi bi-journal-bookmark"></i> <span id="summary-source"></span></p>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="summary-content" class="markdown-content"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Calculator Modal -->
<div class="modal fade" id="calculatorModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-calculator"></i> Calculadora Científica</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="calculator">
                    <!-- Display -->
                    <div class="calc-display mb-3">
                        <input type="text" id="calc-input" class="form-control form-control-lg text-end" readonly value="0">
                        <div id="calc-fraction" class="text-end text-muted small mt-1" style="min-height: 20px;"></div>
                    </div>

                    <!-- Format Toggle -->
                    <div class="mb-3 text-center">
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="calc-format" id="format-decimal" checked>
                            <label class="btn btn-outline-primary btn-sm" for="format-decimal">Decimal</label>

                            <input type="radio" class="btn-check" name="calc-format" id="format-fraction">
                            <label class="btn btn-outline-primary btn-sm" for="format-fraction">Fracción</label>
                        </div>
                    </div>

                    <!-- Calculator Buttons -->
                    <div class="calc-buttons">
                        <div class="row g-2 mb-2">
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="sin">sin</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="cos">cos</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="tan">tan</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="sqrt">√</button></div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="^">x^y</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="(">(</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value=")">)</button></div>
                            <div class="col-3"><button class="btn btn-danger w-100 calc-btn" data-action="clear">C</button></div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-3"><button class="btn btn-light w-100 calc-btn" data-value="7">7</button></div>
                            <div class="col-3"><button class="btn btn-light w-100 calc-btn" data-value="8">8</button></div>
                            <div class="col-3"><button class="btn btn-light w-100 calc-btn" data-value="9">9</button></div>
                            <div class="col-3"><button class="btn btn-warning w-100 calc-btn" data-value="/">÷</button></div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-3"><button class="btn btn-light w-100 calc-btn" data-value="4">4</button></div>
                            <div class="col-3"><button class="btn btn-light w-100 calc-btn" data-value="5">5</button></div>
                            <div class="col-3"><button class="btn btn-light w-100 calc-btn" data-value="6">6</button></div>
                            <div class="col-3"><button class="btn btn-warning w-100 calc-btn" data-value="*">×</button></div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-3"><button class="btn btn-light w-100 calc-btn" data-value="1">1</button></div>
                            <div class="col-3"><button class="btn btn-light w-100 calc-btn" data-value="2">2</button></div>
                            <div class="col-3"><button class="btn btn-light w-100 calc-btn" data-value="3">3</button></div>
                            <div class="col-3"><button class="btn btn-warning w-100 calc-btn" data-value="-">−</button></div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-3"><button class="btn btn-light w-100 calc-btn" data-value="0">0</button></div>
                            <div class="col-3"><button class="btn btn-light w-100 calc-btn" data-value=".">.</button></div>
                            <div class="col-3"><button class="btn btn-success w-100 calc-btn" data-action="equals">=</button></div>
                            <div class="col-3"><button class="btn btn-warning w-100 calc-btn" data-value="+">+</button></div>
                        </div>
                        <div class="row g-2">
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="pi">π</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="e">e</button></div>
                            <div class="col-3"><button class="btn btn-info w-100 calc-btn" data-action="backspace">←</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="%">%</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- MathJax for LaTeX rendering (MathJax 3 no necesita polyfill.io) -->
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<!-- Mermaid for diagram rendering -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<!-- Math.js for calculator with fraction support -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>

<script>
// Configure marked to support line breaks
marked.setOptions({
    breaks: true,
    gfm: true
});

// Initialize Mermaid
mermaid.initialize({
    startOnLoad: false,
    theme: 'default',
    securityLevel: 'loose'
});

let currentExerciseId = null;
let currentProcedures = [];
let hasRetried = false;
let hintsPurchased = 0;

document.getElementById('generate-btn').addEventListener('click', generateExercise);
document.getElementById('submit-btn').addEventListener('click', submitExercise);
document.getElementById('hint-btn').addEventListener('click', buyHint);

function generateExercise() {
    const difficulty = document.getElementById('difficulty-select').value;
    const btn = document.getElementById('generate-btn');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generando...';

    fetch('{{ url_for("student.generate_exercise") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ difficulty: difficulty })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentExerciseId = data.exercise.id;
            currentProcedures = data.exercise.available_procedures || [];
            hasRetried = false;  // Reset retry flag for new exercise
            hintsPurchased = 0;  // Reset hints counter for new exercise

            // Reset hint button state
            document.getElementById('hint-btn').disabled = false;
            document.getElementById('hint-btn-text').textContent = 'Comprar Pista 1 (5 puntos)';

            // Render markdown content to HTML
            const exerciseHTML = marked.parse(data.exercise.content);
            document.getElementById('exercise-content').innerHTML = exerciseHTML;
            document.getElementById('exercise-topic').textContent = data.exercise.topic;

            // Populate procedures checkboxes
            displayProcedures(currentProcedures);

            document.getElementById('no-exercise').classList.add('d-none');
            document.getElementById('exercise-display').classList.remove('d-none');
            document.getElementById('feedback-display').classList.add('d-none');
            document.getElementById('hint-display').classList.add('d-none');

            // Clear previous answers
            document.getElementById('student-answer').value = '';

            // Render LaTeX math with MathJax
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise([document.getElementById('exercise-content')]).catch((err) => console.log('MathJax error:', err));
            }

            // Trigger rolling prefetch: cache next exercise while student works
            prefetchNextExercise(data.exercise.topic_id, data.exercise.difficulty);
        } else {
            alert('Error: ' + data.message);
        }

        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-stars"></i> Generar Ejercicio';
    })
    .catch(error => {
        alert('Error al generar ejercicio');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-stars"></i> Generar Ejercicio';
    });
}

function displayProcedures(procedures) {
    const listDiv = document.getElementById('procedures-list');

    if (!procedures || procedures.length === 0) {
        listDiv.innerHTML = '<p class="text-muted">No hay procedimientos disponibles para este ejercicio.</p>';
        return;
    }

    let html = '<p class="text-muted mb-3">Selecciona todos los procedimientos, técnicas o propiedades que utilizaste:</p>';

    procedures.forEach(proc => {
        const description = proc.description || 'Sin descripción disponible';
        html += `
            <div class="form-check mb-2 procedure-item">
                <input class="form-check-input" type="checkbox" value="${proc.id}" id="proc-${proc.id}">
                <label class="form-check-label" for="proc-${proc.id}"
                       data-bs-toggle="tooltip"
                       data-bs-placement="right"
                       data-bs-html="true"
                       title="<strong>${proc.name}</strong><br>${description}">
                    ${proc.name} <i class="bi bi-info-circle text-muted"></i>
                </label>
            </div>
        `;
    });

    listDiv.innerHTML = html;

    // Initialize Bootstrap tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
}

function getSelectedProcedures() {
    const checkboxes = document.querySelectorAll('#procedures-list input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => parseInt(cb.value));
}

function prefetchNextExercise(topicId, difficulty) {
    // Rolling prefetch: cache next exercise while student works on current one
    fetch('{{ url_for("student.prefetch_next") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            topic_id: topicId,
            difficulty: difficulty
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('[RollingPrefetch] Next exercise caching started');
        }
    })
    .catch(error => {
        console.log('[RollingPrefetch] Failed to start:', error);
    });
}

function submitExercise() {
    const answer = document.getElementById('student-answer').value;
    const selectedProcedures = getSelectedProcedures();

    if (!answer.trim()) {
        alert('Por favor escribe tu respuesta');
        return;
    }

    if (currentProcedures.length > 0 && selectedProcedures.length === 0) {
        alert('Por favor selecciona al menos un procedimiento/técnica utilizada');
        return;
    }

    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Evaluando...';

    fetch('{{ url_for("student.submit_exercise") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            exercise_id: currentExerciseId,
            answer: answer,
            methodology: '',
            selected_procedures: selectedProcedures,
            is_retry: hasRetried
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayFeedback(data.evaluation);
            updateProgress(data.evaluation);
        } else {
            alert('Error: ' + data.message);
        }

        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Enviar Respuesta';
    })
    .catch(error => {
        alert('Error al evaluar ejercicio');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Enviar Respuesta';
    });
}

function displayFeedback(evaluation) {
    const feedbackDiv = document.getElementById('feedback-display');
    const isCorrect = evaluation.is_correct;

    let feedbackClass = isCorrect ? 'success' : 'error';
    let icon = isCorrect ? 'check-circle-fill' : 'x-circle-fill';
    let title = isCorrect ? '¡Excelente! Respuesta correcta' : 'Respuesta incorrecta';

    let feedbackContent = '';
    let actionButtons = '';

    if (!isCorrect) {
        if (!hasRetried) {
            // First attempt failed - show simple message and retry button only
            feedbackContent = '<p class="mb-3">Tu respuesta no es correcta. Intenta resolverlo de nuevo.</p>';
            actionButtons = '<button class="btn btn-primary mt-3" onclick="retryExercise()"><i class="bi bi-arrow-repeat"></i> Reintentar (+3 puntos por esfuerzo)</button>';
        } else {
            // Second attempt failed - show detailed feedback and solution
            const feedbackHTML = marked.parse(evaluation.feedback);
            feedbackContent = `
                <div class="feedback-text markdown-content">
                    ${feedbackHTML}
                </div>
                <div class="alert alert-info mt-3">
                    <h6><i class="bi bi-info-circle"></i> Solución:</h6>
                    <div class="markdown-content">${evaluation.solution ? marked.parse(evaluation.solution) : 'No disponible'}</div>
                </div>
            `;
            actionButtons = '<button class="btn btn-secondary mt-3" onclick="newExercise()"><i class="bi bi-plus-circle"></i> Nuevo Ejercicio</button>';
        }
    } else {
        // Correct answer - show detailed feedback and new exercise button
        const feedbackHTML = marked.parse(evaluation.feedback);
        feedbackContent = `
            <div class="feedback-text markdown-content">
                ${feedbackHTML}
            </div>
        `;
        actionButtons = '<button class="btn btn-secondary mt-3" onclick="newExercise()"><i class="bi bi-plus-circle"></i> Nuevo Ejercicio</button>';
    }

    feedbackDiv.innerHTML = `
        <div class="feedback-box ${feedbackClass}">
            <h4><i class="bi bi-${icon}"></i> ${title}</h4>
            <p><strong>Puntos obtenidos:</strong> ${evaluation.score}</p>
            ${evaluation.streak_bonus > 0 ? `<p><strong>¡Bonus por racha!</strong> +${evaluation.streak_bonus} puntos</p>` : ''}
            <hr>
            ${feedbackContent}
            ${actionButtons}
        </div>
    `;

    feedbackDiv.classList.remove('d-none');

    // Render LaTeX math with MathJax
    if (typeof MathJax !== 'undefined') {
        MathJax.typesetPromise([feedbackDiv]).catch((err) => console.log('MathJax error:', err));
    }
}

function updateProgress(evaluation) {
    document.getElementById('points-display').textContent = evaluation.available_points;
    document.getElementById('streak-display').textContent = evaluation.current_streak;
}

function buyHint() {
    if (!currentExerciseId) return;

    const hintLevel = hintsPurchased + 1;
    const hintTypeName = hintLevel === 1 ? 'textual' : 'esquema visual';

    if (!confirm(`¿Comprar pista ${hintLevel} (${hintTypeName}) por 5 puntos?`)) return;

    const btn = document.getElementById('hint-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generando...';

    fetch('{{ url_for("student.buy_hint") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ exercise_id: currentExerciseId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hintsPurchased = data.hint_level;

            // Update hint display based on type
            const hintContent = document.getElementById('hint-content');
            const hintTitle = document.getElementById('hint-title');

            if (data.hint_type === 'text') {
                // Text hint - use textContent to avoid escaping issues
                hintTitle.textContent = 'Pista 1 - Sugerencia:';
                const p = document.createElement('p');
                p.textContent = data.hint;
                hintContent.innerHTML = '';
                hintContent.appendChild(p);
            } else if (data.hint_type === 'visual') {
                // Visual scheme with Mermaid
                hintTitle.textContent = 'Pista 2 - Esquema Visual:';
                const mermaidId = 'mermaid-' + Date.now();
                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.id = mermaidId;
                mermaidDiv.textContent = data.hint;
                hintContent.innerHTML = '';
                hintContent.appendChild(mermaidDiv);

                // Render Mermaid diagram
                mermaid.run({ nodes: [mermaidDiv] }).catch(err => {
                    console.error('Mermaid error:', err);
                    hintContent.innerHTML = '<p class="text-danger">Error al renderizar el diagrama. Código Mermaid:</p>';
                    const pre = document.createElement('pre');
                    pre.textContent = data.hint;
                    hintContent.appendChild(pre);
                });
            }

            document.getElementById('hint-display').classList.remove('d-none');

            // Update button state - fix order to avoid null reference
            if (data.hints_remaining > 0) {
                // First update innerHTML, then enable
                btn.innerHTML = '<i class="bi bi-lightbulb"></i> <span id="hint-btn-text">Comprar Pista ' + (hintsPurchased + 1) + ' (5 puntos)</span>';
                btn.disabled = false;
            } else {
                btn.innerHTML = '<i class="bi bi-lightbulb"></i> Todas las pistas compradas';
                btn.disabled = true;
            }

            // Update points display
            const stats = {{ stats|tojson }};
            if (stats) {
                document.getElementById('points-display').textContent = stats.available_points - (hintsPurchased * 5);
            }
        } else {
            alert(data.message);
            btn.innerHTML = '<i class="bi bi-lightbulb"></i> <span id="hint-btn-text">Comprar Pista ' + (hintsPurchased + 1) + ' (5 puntos)</span>';
            btn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al comprar pista');
        btn.innerHTML = '<i class="bi bi-lightbulb"></i> <span id="hint-btn-text">Comprar Pista ' + (hintsPurchased + 1) + ' (5 puntos)</span>';
        btn.disabled = false;
    });
}

function retryExercise() {
    hasRetried = true;  // Mark that student is retrying
    document.getElementById('feedback-display').classList.add('d-none');
    document.getElementById('student-answer').value = '';

    // Uncheck all procedures
    const checkboxes = document.querySelectorAll('#procedures-list input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);

    document.getElementById('student-answer').focus();
}

function newExercise() {
    hasRetried = false;  // Reset retry flag
    hintsPurchased = 0;  // Reset hints counter
    document.getElementById('exercise-display').classList.add('d-none');
    document.getElementById('feedback-display').classList.add('d-none');
    document.getElementById('hint-display').classList.add('d-none');
    document.getElementById('no-exercise').classList.remove('d-none');

    // Reset hint button
    document.getElementById('hint-btn').disabled = false;
    document.getElementById('hint-btn-text').textContent = 'Comprar Pista 1 (5 puntos)';
}

// ============ SCIENTIFIC CALCULATOR ============
let calcExpression = '';
let calcResult = null;
let calcShowFraction = false;

document.addEventListener('DOMContentLoaded', function() {
    // Calculator button handlers
    const calcButtons = document.querySelectorAll('.calc-btn');
    const calcInput = document.getElementById('calc-input');
    const calcFraction = document.getElementById('calc-fraction');

    calcButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const value = this.dataset.value;
            const action = this.dataset.action;

            if (action === 'clear') {
                calcExpression = '';
                calcResult = null;
                updateCalcDisplay();
            } else if (action === 'backspace') {
                calcExpression = calcExpression.slice(0, -1);
                updateCalcDisplay();
            } else if (action === 'equals') {
                calculateResult();
            } else if (value) {
                // Add value to expression
                if (calcExpression === '0' && value !== '.') {
                    calcExpression = value;
                } else {
                    calcExpression += value;
                }
                updateCalcDisplay();
            }
        });
    });

    // Format toggle handlers
    document.getElementById('format-decimal').addEventListener('change', function() {
        if (this.checked) {
            calcShowFraction = false;
            updateCalcDisplay();
        }
    });

    document.getElementById('format-fraction').addEventListener('change', function() {
        if (this.checked) {
            calcShowFraction = true;
            updateCalcDisplay();
        }
    });

    // Reset calculator when modal is opened
    document.getElementById('calculatorModal').addEventListener('show.bs.modal', function() {
        calcExpression = '';
        calcResult = null;
        calcShowFraction = false;
        document.getElementById('format-decimal').checked = true;
        updateCalcDisplay();
    });

    function updateCalcDisplay() {
        const calcInput = document.getElementById('calc-input');
        const calcFraction = document.getElementById('calc-fraction');

        if (calcResult !== null) {
            // Show result
            if (calcShowFraction) {
                try {
                    const frac = math.fraction(calcResult);
                    calcInput.value = `${frac.n}/${frac.d}`;
                    calcFraction.textContent = `≈ ${parseFloat(calcResult.toPrecision(10))}`;
                } catch (e) {
                    calcInput.value = parseFloat(calcResult.toPrecision(10));
                    calcFraction.textContent = '';
                }
            } else {
                calcInput.value = parseFloat(calcResult.toPrecision(10));
                // Show fraction equivalent
                try {
                    const frac = math.fraction(calcResult);
                    if (frac.d !== 1 && frac.d < 1000) {
                        calcFraction.textContent = `= ${frac.n}/${frac.d}`;
                    } else {
                        calcFraction.textContent = '';
                    }
                } catch (e) {
                    calcFraction.textContent = '';
                }
            }
        } else {
            // Show expression
            calcInput.value = calcExpression || '0';
            calcFraction.textContent = '';
        }
    }

    function calculateResult() {
        if (!calcExpression) return;

        try {
            // Replace common symbols
            let expr = calcExpression
                .replace(/×/g, '*')
                .replace(/÷/g, '/')
                .replace(/−/g, '-')
                .replace(/π/g, 'pi')
                .replace(/sqrt/g, 'sqrt');

            // Evaluate expression using math.js
            calcResult = math.evaluate(expr);
            calcExpression = '';
            updateCalcDisplay();
        } catch (error) {
            alert('Error en la expresión: ' + error.message);
            calcExpression = '';
            calcResult = null;
            updateCalcDisplay();
        }
    }
});

// Summary purchase functionality
document.addEventListener('DOMContentLoaded', function() {
    const summaryModal = new bootstrap.Modal(document.getElementById('summaryModal'));

    // Use event delegation to handle clicks on summary buttons (works even after content changes)
    document.addEventListener('click', function(e) {
        // Check if clicked element or its parent is a buy-summary-btn
        const btn = e.target.closest('.buy-summary-btn');
        if (!btn) return;

        e.preventDefault();

        const topicId = btn.dataset.topicId;
        const topicName = btn.dataset.topicName;
        const originalHtml = btn.innerHTML;

        // Disable button and show loading
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        fetch('{{ url_for("student.buy_summary") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ topic_id: parseInt(topicId) })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update points display
                document.getElementById('points-display').textContent = data.available_points;

                // Set modal content
                document.getElementById('summary-topic-name').textContent = data.topic_name;
                document.getElementById('summary-source').textContent = data.source || 'Fuente desconocida';

                // Render markdown content
                const summaryHtml = marked.parse(data.summary);
                document.getElementById('summary-content').innerHTML = summaryHtml;

                // Trigger MathJax rendering for LaTeX formulas
                if (window.MathJax) {
                    MathJax.typesetPromise([document.getElementById('summary-content')]);
                }

                // Show modal
                summaryModal.show();

                // Update button based on re-access status
                if (data.is_reaccess) {
                    // Already purchased, just show it was free
                    btn.innerHTML = '<i class="bi bi-check-circle"></i> Ver (GRATIS)';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-info');
                } else {
                    // First purchase
                    btn.innerHTML = '<i class="bi bi-check-circle"></i> Ver (GRATIS)';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-info');
                    // Show purchase confirmation without blocking
                    setTimeout(() => alert(data.message), 100);
                }
            } else {
                alert(data.message);
                btn.innerHTML = originalHtml;
            }
            btn.disabled = false;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al acceder al resumen. Por favor, intenta de nuevo.');
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        });
    });
});
</script>
{% endblock %}
