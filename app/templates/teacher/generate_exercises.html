{% extends "base/base.html" %}

{% block title %}Generar Ejercicios - MathMentor IA{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="mb-4">
                <i class="bi bi-cpu"></i> Generar Ejercicios con IA
            </h1>

            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Configuraci칩n de Generaci칩n</h5>
                </div>
                <div class="card-body">
                    <form id="generateForm">
                        <div class="mb-3">
                            <label for="source-filter" class="form-label">Filtrar por Fuente</label>
                            <select class="form-select" id="source-filter" onchange="filterTopics()">
                                <option value="">Todas las fuentes</option>
                                <optgroup label="游닄 Libros">
                                    {% for book in books %}
                                    <option value="book_{{ book.id }}">{{ book.title }} ({{ book.course }} - {{ book.subject }})</option>
                                    {% endfor %}
                                </optgroup>
                                <optgroup label="游꿘 Canales de YouTube">
                                    {% for channel in channels %}
                                    <option value="channel_{{ channel.id }}">{{ channel.channel_name }}</option>
                                    {% endfor %}
                                </optgroup>
                            </select>
                            <div class="form-text">Filtra los temas por su fuente de origen</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Temas a generar *</label>
                            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 10px;">
                                {% for topic in topics %}
                                <div class="form-check topic-item"
                                     data-source-type="{{ topic.source_type }}"
                                     data-book-id="{{ topic.book_id if topic.book_id else '' }}"
                                     data-video-id="{{ topic.video_id if topic.video_id else '' }}"
                                     data-channel-id="{{ topic.video.channel_id if topic.source_type == 'youtube_video' and topic.video else '' }}">
                                    <input class="form-check-input topic-checkbox" type="checkbox"
                                           value="{{ topic.id }}" id="topic{{ topic.id }}">
                                    <label class="form-check-label" for="topic{{ topic.id }}">
                                        {{ topic.topic_name }}
                                        {% if topic.source_type == 'pdf_book' and topic.book %}
                                            <small class="text-muted">(游닄 {{ topic.book.title }})</small>
                                        {% elif topic.source_type == 'youtube_video' and topic.video %}
                                            <small class="text-muted">(游꿘 {{ topic.video.channel.channel_name if topic.video.channel else 'YouTube' }})</small>
                                        {% endif %}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="form-text">Selecciona los temas para los que quieres generar ejercicios</div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAll()">
                                    Seleccionar todos
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">
                                    Deseleccionar todos
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="difficulty" class="form-label">Dificultad *</label>
                            <select class="form-select" id="difficulty" name="difficulty" required>
                                <option value="easy">F치cil</option>
                                <option value="medium" selected>Media</option>
                                <option value="hard">Dif칤cil</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="quantity" class="form-label">Cantidad *</label>
                            <input type="number" class="form-control" id="quantity" name="quantity"
                                   min="1" max="20" value="5" required>
                            <div class="form-text">N칰mero de ejercicios a generar (1-20)</div>
                        </div>

                        <div class="mb-3">
                            <label for="course" class="form-label">Curso</label>
                            <select class="form-select" id="course" name="course">
                                {% for course in courses %}
                                <option value="{{ course.name }}">{{ course.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Nota:</strong> Los ejercicios generados tendr치n estado "Pendiente de validaci칩n".
                            Podr치s revisarlos y editarlos antes de validarlos para que est칠n disponibles para los estudiantes.
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="generateBtn">
                                <i class="bi bi-cpu"></i> Generar Ejercicios
                            </button>
                            <a href="{{ url_for('teacher.dashboard') }}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Volver
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Progress Section (hidden initially) -->
            <div id="progressSection" class="card mt-4" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-hourglass-split"></i> Generando...</h5>
                </div>
                <div class="card-body">
                    <div class="progress" style="height: 30px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <p class="text-center mt-3" id="progressText">Iniciando generaci칩n...</p>
                </div>
            </div>

            <!-- Results Section (hidden initially) -->
            <div id="resultsSection" class="card mt-4" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-check-circle"></i> Ejercicios Generados</h5>
                </div>
                <div class="card-body">
                    <p id="resultsMessage"></p>
                    <div class="d-grid gap-2">
                        <a href="#" id="viewExercisesBtn" class="btn btn-primary">
                            <i class="bi bi-eye"></i> Ver Ejercicios Generados
                        </a>
                        <button class="btn btn-secondary" onclick="location.reload()">
                            <i class="bi bi-arrow-repeat"></i> Generar M치s Ejercicios
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function filterTopics() {
    const sourceFilter = document.getElementById('source-filter').value;
    const topicItems = document.querySelectorAll('.topic-item');

    // Deselect all checkboxes when filtering
    document.querySelectorAll('.topic-checkbox').forEach(cb => cb.checked = false);

    topicItems.forEach(item => {
        const sourceType = item.dataset.sourceType;
        const bookId = item.dataset.bookId;
        const channelId = item.dataset.channelId;

        // If no filter, show all
        if (!sourceFilter) {
            item.style.display = '';
            return;
        }

        // Check if matches book filter
        if (sourceFilter.startsWith('book_')) {
            const filteredBookId = sourceFilter.replace('book_', '');
            if (sourceType === 'pdf_book' && bookId === filteredBookId) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        }
        // Check if matches channel filter
        else if (sourceFilter.startsWith('channel_')) {
            const filteredChannelId = sourceFilter.replace('channel_', '');
            if (sourceType === 'youtube_video' && channelId === filteredChannelId) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        }
    });
}

function selectAll() {
    // Only select visible checkboxes
    document.querySelectorAll('.topic-item').forEach(item => {
        if (item.style.display !== 'none') {
            const checkbox = item.querySelector('.topic-checkbox');
            if (checkbox) checkbox.checked = true;
        }
    });
}

function deselectAll() {
    document.querySelectorAll('.topic-checkbox').forEach(cb => cb.checked = false);
}

document.getElementById('generateForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const selectedTopics = Array.from(document.querySelectorAll('.topic-checkbox:checked'))
        .map(cb => parseInt(cb.value));

    if (selectedTopics.length === 0) {
        alert('Por favor selecciona al menos un tema');
        return;
    }

    const formData = {
        topic_ids: selectedTopics,
        difficulty: document.getElementById('difficulty').value,
        quantity: parseInt(document.getElementById('quantity').value),
        course: document.getElementById('course').value
    };

    // Show progress
    document.getElementById('progressSection').style.display = 'block';
    document.getElementById('generateBtn').disabled = true;
    document.getElementById('generateBtn').innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generando...';

    // Simulate progress (since actual generation might take time)
    let progress = 0;
    const totalExercises = formData.topic_ids.length * formData.quantity;
    const progressInterval = setInterval(() => {
        progress += 5;
        if (progress <= 90) {
            updateProgress(progress, `Generando ejercicios para ${formData.topic_ids.length} tema(s)...`);
        }
    }, 500);

    // Make request
    fetch('/teacher/generate-exercises', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        updateProgress(100, 'Completado');

        if (data.success) {
            // Reset button
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateBtn').innerHTML = '<i class="bi bi-cpu"></i> Generar Ejercicios';

            setTimeout(() => {
                document.getElementById('progressSection').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('resultsMessage').innerHTML = `
                    <p class="lead"><i class="bi bi-check-circle-fill text-success"></i> ${data.message}</p>
                    <p>Los ejercicios est치n listos para ser revisados y validados.</p>
                `;
                document.getElementById('viewExercisesBtn').href = '/teacher/exercises?status=pending_validation';
            }, 500);
        } else {
            alert('Error: ' + data.message);
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateBtn').innerHTML = '<i class="bi bi-cpu"></i> Generar Ejercicios';
            document.getElementById('progressSection').style.display = 'none';
        }
    })
    .catch(error => {
        clearInterval(progressInterval);
        console.error('Error:', error);
        alert('Error al generar ejercicios: ' + error.message);
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('generateBtn').innerHTML = '<i class="bi bi-cpu"></i> Generar Ejercicios';
        document.getElementById('progressSection').style.display = 'none';
    });
});

function updateProgress(percentage, text) {
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = percentage + '%';
    progressBar.textContent = percentage + '%';
    document.getElementById('progressText').textContent = text;
}
</script>
{% endblock %}
