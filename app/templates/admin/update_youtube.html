{% extends "base/base.html" %}

{% block title %}Actualizar Canal YouTube - MathMentor IA{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 offset-md-1">
        <h2 class="mb-4"><i class="bi bi-arrow-clockwise"></i> Actualizar Canal de YouTube</h2>

        <div class="card">
            <div class="card-body">
                <form method="POST" id="youtubeForm">
                    {{ form.hidden_tag() }}

                    <!-- Step 1: Channel URL and Course/Subject -->
                    <div id="step1">
                        <h4 class="mb-3">Información del Canal</h4>
                        <div class="alert alert-success mb-3">
                            <i class="bi bi-info-circle"></i> Este canal ya está configurado. Los campos se han rellenado automáticamente. Haz clic en <strong>"Buscar Nuevos Videos"</strong> para encontrar videos que aún no han sido importados.
                        </div>

                        <div class="mb-3">
                            {{ form.channel_url.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.channel_url(class="form-control", id="channelUrlInput") }}
                                <button type="button" class="btn btn-danger" id="loadVideosBtn">
                                    <i class="bi bi-search"></i> Buscar Nuevos Videos
                                </button>
                            </div>
                            <small class="text-muted">Ejemplo: https://www.youtube.com/@nombrecanal</small>
                            {% if form.channel_url.errors %}
                                <div class="text-danger">
                                    {% for error in form.channel_url.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.course.label(class="form-label") }}
                                {{ form.course(class="form-control") }}
                                {% if form.course.errors %}
                                    <div class="text-danger">
                                        {% for error in form.course.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                {{ form.subject.label(class="form-label") }}
                                {{ form.subject(class="form-control") }}
                                {% if form.subject.errors %}
                                    <div class="text-danger">
                                        {% for error in form.subject.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Video Selection (Initially Hidden) -->
                    <div id="step2" style="display: none;">
                        <hr class="my-4">
                        <h4 class="mb-3">Seleccionar Videos Nuevos</h4>

                        <div id="channelInfo" class="alert alert-info mb-3" style="display: none;">
                            <h5><i class="bi bi-youtube"></i> <span id="channelName"></span></h5>
                            <p class="mb-1"><strong>Videos ya importados:</strong> <span id="existingVideos">0</span></p>
                            <p class="mb-0"><strong>Videos nuevos encontrados:</strong> <span id="totalVideos">0</span> <span id="loadTime"></span></p>
                        </div>

                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllBtn">
                                <i class="bi bi-check-square"></i> Seleccionar Todos
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllBtn">
                                <i class="bi bi-square"></i> Deseleccionar Todos
                            </button>
                            <span class="ms-3 text-muted">
                                <strong>Seleccionados:</strong> <span id="selectedCount">0</span>
                            </span>
                        </div>

                        <div id="videosList" class="border rounded p-3" style="max-height: 500px; overflow-y: auto;">
                            <!-- Videos will be loaded here via AJAX -->
                        </div>

                        <!-- Hidden field to store selected video IDs -->
                        <input type="hidden" name="selected_videos" id="selectedVideosInput">
                    </div>

                    <!-- Loading Indicator -->
                    <div id="loadingIndicator" style="display: none;" class="text-center my-4">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Buscando videos nuevos en el canal...</p>
                        <small class="text-muted">Esto puede tardar varios segundos...</small>
                        <p class="mt-2"><small id="loadingTime" class="text-muted"></small></p>
                    </div>

                    <!-- Error Message -->
                    <div id="errorMessage" class="alert alert-danger" style="display: none;" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> <span id="errorText"></span>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2 mt-4">
                        {{ form.submit(class="btn btn-danger btn-lg", id="submitBtn", style="display: none;") }}
                        <a href="{{ url_for('admin.content') }}" class="btn btn-secondary">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>

        <div class="alert alert-info mt-4">
            <h5><i class="bi bi-info-circle"></i> Cómo funciona la actualización:</h5>
            <ol>
                <li>Los datos del canal ya están configurados (URL, curso, materia)</li>
                <li>Haz clic en <strong>"Buscar Nuevos Videos"</strong> para verificar si hay videos nuevos</li>
                <li>El sistema mostrará solo los videos que aún NO han sido importados</li>
                <li>Selecciona los videos nuevos que deseas añadir (puedes usar "Seleccionar Todos")</li>
                <li>Haz clic en <strong>"Importar Videos Seleccionados"</strong></li>
                <li>Se extraerán las transcripciones y se generarán embeddings para RAG</li>
                <li>Cada video nuevo se creará como un tema independiente para asignar a estudiantes</li>
            </ol>
            <p class="mb-0">
                <i class="bi bi-info-circle-fill text-primary"></i>
                <strong>Nota:</strong> Solo se procesarán videos con transcripción disponible (subtítulos automáticos o manuales).
            </p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadVideosBtn = document.getElementById('loadVideosBtn');
    const channelUrlInput = document.getElementById('channelUrlInput');
    const step2 = document.getElementById('step2');
    const videosList = document.getElementById('videosList');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const channelInfo = document.getElementById('channelInfo');
    const channelName = document.getElementById('channelName');
    const totalVideos = document.getElementById('totalVideos');
    const existingVideos = document.getElementById('existingVideos');
    const loadTime = document.getElementById('loadTime');
    const selectedCount = document.getElementById('selectedCount');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const selectedVideosInput = document.getElementById('selectedVideosInput');
    const submitBtn = document.getElementById('submitBtn');
    const youtubeForm = document.getElementById('youtubeForm');
    const loadingTime = document.getElementById('loadingTime');

    if (!loadVideosBtn) {
        console.error('Error: Load Videos Button not found');
        return;
    }

    let videosData = [];
    let loadingStartTime;
    let loadingTimer;

    // Load videos from channel
    loadVideosBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const url = channelUrlInput.value.trim();

        if (!url) {
            showError('Por favor, ingresa la URL del canal');
            return;
        }

        // Reset state
        errorMessage.style.display = 'none';
        videosList.innerHTML = '';
        step2.style.display = 'none';
        submitBtn.style.display = 'none';
        loadingIndicator.style.display = 'block';
        loadingStartTime = Date.now();

        // Update loading time every second
        loadingTimer = setInterval(function() {
            const elapsed = Math.floor((Date.now() - loadingStartTime) / 1000);
            loadingTime.textContent = `Tiempo transcurrido: ${elapsed}s`;
        }, 1000);

        // Get CSRF token
        const csrfTokenInput = document.querySelector('input[name="csrf_token"]');

        if (!csrfTokenInput) {
            loadingIndicator.style.display = 'none';
            showError('Error de configuración: token CSRF no encontrado');
            return;
        }

        const csrfToken = csrfTokenInput.value;
        const fetchUrl = '{{ url_for("admin.fetch_new_youtube_videos", channel_id=channel.id) }}';

        // Fetch videos via AJAX
        fetch(fetchUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ channel_url: url })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error('Error en la respuesta del servidor: ' + response.status);
                });
            }
            return response.json();
        })
        .then(data => {
            // Stop timer and calculate final time
            clearInterval(loadingTimer);
            const totalTime = ((Date.now() - loadingStartTime) / 1000).toFixed(1);

            loadingIndicator.style.display = 'none';

            if (data.error) {
                showError(data.error);
                return;
            }

            // Store videos data
            videosData = data.videos;

            // Show channel info with loading time
            channelName.textContent = '{{ channel.channel_name }}';
            existingVideos.textContent = data.existing_videos || 0;
            totalVideos.textContent = data.total_videos;
            loadTime.textContent = `(cargados en ${totalTime}s)`;
            channelInfo.style.display = 'block';

            // Check if there are new videos
            if (data.total_videos === 0) {
                videosList.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> <strong>¡Perfecto!</strong> No hay videos nuevos. Todos los videos del canal ya han sido importados.</div>';
                step2.style.display = 'block';
                return;
            }

            // Render videos list
            renderVideosList(data.videos);

            // Show step 2
            step2.style.display = 'block';
            submitBtn.style.display = 'block';
            updateSelectedCount();
        })
        .catch(error => {
            clearInterval(loadingTimer);
            console.error('Error loading videos:', error);
            loadingIndicator.style.display = 'none';
            showError('Error al cargar los videos: ' + error.message);
        });
    });

    // Render videos list
    function renderVideosList(videos) {
        if (videos.length === 0) {
            videosList.innerHTML = '<p class="text-muted">No se encontraron videos en este canal.</p>';
            return;
        }

        let html = '<div class="list-group">';
        videos.forEach((video, index) => {
            html += `
                <div class="list-group-item">
                    <div class="form-check">
                        <input class="form-check-input video-checkbox" type="checkbox"
                               value="${video.video_id}" id="video_${index}">
                        <label class="form-check-label w-100" for="video_${index}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${escapeHtml(video.title)}</h6>
                                    <small class="text-muted">
                                        <i class="bi bi-clock"></i> ${video.duration}
                                        | <i class="bi bi-calendar"></i> ${video.published_at}
                                    </small>
                                </div>
                                <a href="${video.url}" target="_blank" class="btn btn-sm btn-outline-danger ms-2">
                                    <i class="bi bi-play-circle"></i>
                                </a>
                            </div>
                        </label>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        videosList.innerHTML = html;

        // Add event listeners to checkboxes
        document.querySelectorAll('.video-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
        });
    }

    // Select all videos
    selectAllBtn.addEventListener('click', function() {
        document.querySelectorAll('.video-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
        updateSelectedCount();
    });

    // Deselect all videos
    deselectAllBtn.addEventListener('click', function() {
        document.querySelectorAll('.video-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectedCount();
    });

    // Update selected count
    function updateSelectedCount() {
        const checked = document.querySelectorAll('.video-checkbox:checked');
        selectedCount.textContent = checked.length;

        // Update hidden field with selected video IDs
        const selectedIds = Array.from(checked).map(cb => cb.value);
        selectedVideosInput.value = JSON.stringify(selectedIds);
    }

    // Show error message
    function showError(message) {
        errorText.textContent = message;
        errorMessage.style.display = 'block';
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Form validation before submit
    youtubeForm.addEventListener('submit', function(e) {
        const selectedIds = JSON.parse(selectedVideosInput.value || '[]');

        if (selectedIds.length === 0) {
            e.preventDefault();
            showError('Debes seleccionar al menos un video nuevo para importar');
            return false;
        }
    });
});
</script>

<style>
.video-checkbox {
    margin-top: 0.5rem;
}

.list-group-item {
    border-left: 3px solid transparent;
    transition: all 0.2s;
}

.list-group-item:has(.video-checkbox:checked) {
    border-left-color: #dc3545;
    background-color: #fff5f5;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}

#videosList {
    background-color: #fafafa;
}
</style>
{% endblock %}
